<!DOCTYPE html>
<!--notes ido:
	Still need to clean the assets/plugin , assets/scripts, assets/img  folders....
-->
<!-- 
Template Name: Metronic - Responsive Admin Dashboard Template build with Twitter Bootstrap 2.3.2
Version: 1.4
Author: KeenThemes
Website: http://www.keenthemes.com/preview/?theme=metronic
Purchase: http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469
-->
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
	<meta charset="utf-8" />

	<meta http-equiv="Access-Control-Allow-Origin" content="*">
	<title>Metronic | Admin Dashboard Template</title>
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<meta content="" name="description" />
	<meta content="" name="author" />
	<!-- BEGIN GLOBAL MANDATORY STYLES -->
	<link href="assets/plugins/bootstrap/css/bootstrap-rtl.min.css" rel="stylesheet" type="text/css"/>
	<link href="assets/plugins/bootstrap/css/bootstrap-responsive-rtl.min.css" rel="stylesheet" type="text/css"/>
	<link href="assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/> <!--icons-->
	<link href="assets/css/style-metro-rtl.css" rel="stylesheet" type="text/css"/>
	<link href="assets/css/style-rtl.css" rel="stylesheet" type="text/css"/>
	<link href="assets/css/style-responsive-rtl.css" rel="stylesheet" type="text/css"/>
	<link href="assets/css/themes/default-rtl.css" rel="stylesheet" type="text/css" id="style_color"/>
	<link href="assets/plugins/bootstrap-switch/static/stylesheets/bootstrap-switch-metro-rtl.css" rel="stylesheet" type="text/css"/>
	<link rel="stylesheet" type="text/css" href="assets/plugins/chosen-bootstrap/chosen/chosen-rtl.css" />
	<link rel="stylesheet" type="text/css" href="assets/plugins/bootstrap-toggle-buttons/static/stylesheets/bootstrap-toggle-buttons-rtl.css" />
	<link rel="stylesheet" type="text/css" href="assets/plugins/data-tables/DT_bootstrap_rtl.css" />
	<link rel="shortcut icon" href="favicon.ico" />
	<link href="style-ido.css" rel="stylesheet" type="text/css"/>

</head>
<body class="page-header-fixed">
	<!-- BEGIN HEADER -->   
	<div class="header navbar navbar-inverse navbar-fixed-top">
		<!-- BEGIN TOP NAVIGATION BAR -->
		<div class="navbar-inner">
			<div class="container-fluid">
				<!-- BEGIN LOGO -->
				<a class="brand" href="index.html">
				<img src="assets/img/logo.png" alt="logo" />
				</a>
				<!-- END LOGO -->
				<!-- BEGIN RESPONSIVE MENU TOGGLER -->
				<a href="javascript:;" class="btn-navbar collapsed" data-toggle="collapse" data-target=".nav-collapse">
				<img src="assets/img/menu-toggler.png" alt="" />
				</a>          
				<!-- END RESPONSIVE MENU TOGGLER -->            
				<!-- BEGIN TOP NAVIGATION MENU -->              
				<ul class="nav pull-left">
					<!-- BEGIN USER LOGIN DROPDOWN -->
					<li class="dropdown user">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
						<span class="username">Bob Nilson</span>
						<i class="icon-angle-down"></i>
						</a>
						<ul class="dropdown-menu">
							<li><a href="login.html"><i class="icon-key"></i> Log Out</a></li>
						</ul>
					</li>
					<!-- END USER LOGIN DROPDOWN -->
					<!-- END USER LOGIN DROPDOWN -->
				</ul>
				<!-- END TOP NAVIGATION MENU --> 
			</div>
		</div>
		<!-- END TOP NAVIGATION BAR -->
	</div>
	<!-- END HEADER -->
	<!-- BEGIN CONTAINER -->
	<div class="page-container">
		<!-- BEGIN SIDEBAR -->
		<div class="page-sidebar nav-collapse collapse">
			<!-- BEGIN SIDEBAR MENU -->        
			<ul class="page-sidebar-menu">
				<li data-section="managers">
					<a href="#">
						<i class="icon-cogs"></i> 
						<span class="title">ניהול משתמשים</span>
						<span class="selected"></span>
					</a>
				</li>
			</ul>
			<!-- END SIDEBAR MENU -->
		</div>
		<!-- END SIDEBAR -->
		<!-- BEGIN PAGE -->
		<div class="page-content">
			<!-- BEGIN PAGE CONTAINER-->
			<div class="container-fluid">
				<!-- BEGIN PAGE HEADER-->
				<div class="row-fluid">
					<div class="span12">
						<!-- BEGIN STYLE CUSTOMIZER -->
							<!-- IDO DELETED -->
						<!-- END STYLE CUSTOMIZER -->    
						<!-- BEGIN PAGE TITLE & BREADCRUMB-->
						<h3 class="page-title">
							פרומונים
							<small>מעשיות וסיפורים</small>
						</h3>
						<!-- END PAGE TITLE & BREADCRUMB-->
					</div>
				</div>
				<!-- END PAGE HEADER-->
				<div id="dashboard">
					<div class="row-fluid" id="managers">
						<!-- BEGIN EXAMPLE TABLE PORTLET-->
						<div class="portlet box blue" id="managers-list">
							<div class="portlet-title">
								<div class="caption"><i class="icon-globe"></i>כל המשתמשים</div>
							</div>
							<div class="portlet-body">
								<div class="table-toolbar">
									<div class="btn-group">
										<button id="add-new-manager" class="btn green">
											Add New <i class="icon-plus"></i>
										</button>
									</div>
								</div>
								<table class="table table-striped table-bordered table-hover" id="tbl-managers">
									<thead>
										<tr>
											<th data-field="name">שם איש הקשר</th>
											<th data-field="vendorName">שם המנוי</th>
											<th data-field="phoneNumber">טלפון</th>
											<th data-field="email">אימייל</th>									
											<th>עריכה</th>
											<th>מחיקה</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
						</div>
						<div class="portlet box blue tabbable" id="edit-item">
							<div class="portlet-title">
								<div class="caption"><i class="icon-reorder"></i>עריכת מנהל</div>
							</div>
							<div class="portlet-body form">
								<div class="tabbable portlet-tabs">
									<ul class="nav nav-tabs">
										<li><a href="#portlet_tab4" data-toggle="tab">Roost</a></li>
										<li><a href="#portlet_tab3" data-toggle="tab">Free WiFi</a></li>
										<li><a href="#portlet_tab2" data-toggle="tab">IVR / SMS</a></li>
										<li class="active"><a href="#portlet_tab1" data-toggle="tab">פרטי איש הקשר</a></li>
									</ul>
									<form class="form-horizontal">
										<div class="tab-content">
											<div class="tab-pane active" id="portlet_tab1">
												<div class="control-group">
													<label class="control-label">שם העסק</label>
													<div class="controls">
														<input type="text" name="name" placeholder="שם העסק" class="m-wrap medium" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">שם איש הקשר</label>
													<div class="controls">
														<input type="text" name="vendorName" placeholder="שם איש הקשר" class="m-wrap medium" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">אימייל</label>
													<div class="controls">
														<input type="text" name="email" placeholder="אימייל" class="m-wrap medium" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">טלפון</label>
													<div class="controls">
														<input type="text" name="phoneNumber" placeholder="טלפון" class="m-wrap medium" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">שם משתמש במערכת</label>
													<div class="controls">
														<input type="text" name="user" placeholder="שם משתמש במערכת" class="m-wrap medium" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">סיסמה</label>
													<div class="controls">
														<input type="text" name="pass" placeholder="סיסמה" class="m-wrap medium" />
													</div>
												</div>
											</div>
											<div class="tab-pane" id="portlet_tab2">
												<div class="control-group">
													<label class="control-label">הטלפון במערכת IVR</label>
													<div class="controls">
														<input type="text" name="ivrPhone" placeholder="טלפון IVR" class="m-wrap medium" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">IVR ID</label>
													<div class="controls">
														<input type="text" name="ivrId" placeholder="IVR ID" class="m-wrap medium" />
													</div>
												</div>
											</div>
											<div class="tab-pane" id="portlet_tab3">
												<div class="control-group">
													<div class="controls">
														<div class="btn-group" >
															<button type="button" id="btn-add-node" class="btn green">
																<i class="icon-plus"></i> הוסף NODE 
															</button>
														</div>
													</div>
												</div>
											</div>
											<div class="tab-pane" id="portlet_tab4">
												<div class="control-group">
													<label class="control-label">Roost geo-location</label>
													<div class="controls">
														<input type="text" name="roostGeoLoc" placeholder="Roost geo-location" class="m-wrap large" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">Roost config key</label>
													<div class="controls">
														<input type="text" name="roostConfKey" placeholder="Roost config key" class="m-wrap large" />
													</div>
												</div>
												<div class="control-group">
													<label class="control-label">Roost secret key</label>
													<div class="controls">
														<input type="text" name="roostSecretKey" placeholder="Roost config key" class="m-wrap large" />
													</div>
												</div>
											</div>
										</div>
									</form>
								</div>
								<div class="form-actions clearfix">
									<a href="javascript:;" class="btn button-previous" id="btn-all-items">
									<i class="m-icon-swapleft"></i> חזרה לכל המשתמשים
									</a>
									<a href="javascript:;" class="btn green button-submit" id="btn-save-item">
									שמור שינויים <i class="m-icon-swapright m-icon-white"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- END PAGE CONTAINER-->    
		</div>
		<!-- END PAGE -->
	</div>
	<!-- END CONTAINER -->
	<!-- BEGIN FOOTER -->
	<div class="footer">
		<div class="footer-inner">
			2013 &copy; Metronic by keenthemes.
		</div>
	</div>
	<!-- END FOOTER -->
	<!-- BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time) -->
	<!-- BEGIN CORE PLUGINS -->   
	<script src="assets/plugins/jquery-1.10.1.min.js" type="text/javascript"></script>
	<!--
	<script src="assets/plugins/jquery-migrate-1.2.1.min.js" type="text/javascript"></script> //removed for deployment
	<!-- IMPORTANT! Load jquery-ui-1.10.1.custom.min.js before bootstrap.min.js to fix bootstrap tooltip conflict with jquery ui tooltip -->
	<script src="assets/plugins/jquery-ui/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>      
	<script src="assets/plugins/bootstrap/js/bootstrap-rtl.min.js" type="text/javascript"></script>
	<!--
	<script src="assets/plugins/bootstrap-hover-dropdown/twitter-bootstrap-hover-dropdown.min.js" type="text/javascript" ></script>
	<!--[if lt IE 9]>
	<script src="assets/plugins/excanvas.min.js"></script>
	<script src="assets/plugins/respond.min.js"></script>  
	<![endif]-->   
	
	<!--<script src="assets/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>-->
	<script src="assets/plugins/jquery.blockui.min.js" type="text/javascript"></script>  

	<!--<script src="assets/plugins/uniform/jquery.uniform.min.js" type="text/javascript" ></script>-->
	<!-- END CORE PLUGINS -->
	<!-- BEGIN PAGE LEVEL PLUGINS -->
	<!--
	<script src="assets/plugins/flot/jquery.flot.js" type="text/javascript"></script>
	<script src="assets/plugins/flot/jquery.flot.resize.js" type="text/javascript"></script>
	<script src="assets/plugins/jquery.pulsate.min.js" type="text/javascript"></script>
	<script src="assets/plugins/bootstrap-daterangepicker/date.js" type="text/javascript"></script>
	<script src="assets/plugins/bootstrap-daterangepicker/daterangepicker-rtl.js" type="text/javascript"></script>     
	<script src="assets/plugins/gritter/js/jquery.gritter.js" type="text/javascript"></script>
	<script src="assets/plugins/fullcalendar/fullcalendar/fullcalendar.min.js" type="text/javascript"></script>
	<script src="assets/plugins/jquery-easy-pie-chart/jquery.easy-pie-chart.js" type="text/javascript"></script>
	<script src="assets/plugins/jquery.sparkline.min.js" type="text/javascript"></script>
	-->
	<script src="assets/plugins/bootstrap-switch/static/js/bootstrap-switch.js" type="text/javascript" ></script><!-- for ON/Off switch -->  
	
	 <script src="assets/plugins/mustache.js" type="text/javascript"></script> <!-- mustache -->
	 <script src="assets/plugins/jquery.ba-throttle-debounce.js" type="text/javascript"></script> <!-- jquery throtle -->
	
	<!-- END PAGE LEVEL PLUGINS -->
	<!-- BEGIN PAGE LEVEL SCRIPTS -->
	<!--<script src="assets/scripts/table-editable.js"></script>-->
	<script type="text/javascript" src="assets/plugins/bootstrap-toggle-buttons/static/js/jquery.toggle.buttons.js"></script>
	<!-- END PAGE LEVEL SCRIPTS -->
	
	<!-- BEGIN EDITABLE TABLE SCRIPTS (ido)-->
	<!--
	<script type="text/javascript" src="assets/plugins/select2/select2.min.js"></script>
	-->

	<script type="text/javascript" src="assets/plugins/data-tables/jquery.dataTables.js"></script>
	<script type="text/javascript" src="assets/plugins/data-tables/DT_bootstrap.js"></script>


	<!-- END EDITABLE TABLE SCRIPTS -->
	<!-- BEGIN IDO JS: -->
	<script type="text/javascript" src="js/jquery.jeditable.js"></script>
	<script type="text/javascript" src="js/jquery.blockui.js"></script>
	<script src="assets/scripts/app.js"></script>     
	<script src="assets/scripts/form-wizard.js"></script>     
	<!--<script src="assets/scripts/table-managed.js"></script>     -->
	<!--NAVIGATION SCRIPT-->
	<script>
		$('.page-sidebar-menu li').on('click', function(){
			$('.page-sidebar-menu li').removeClass('active');
			$(this).addClass('active');
			
			$('#dashboard > .row-fluid').hide();
			var section = $(this).attr('data-section'); 
			$('#dashboard #' + section + '.row-fluid').fadeIn();
		});
		
		$(document).ready(function(){
			$('.page-sidebar-menu li:nth-child(1)').trigger('click');
		});
	</script>

	<!--CAMPAIGNS -->
	<script>	
	/*Global vars*/
	var numOfRows=0;
	var oTable;

	function addNewNode(nodeMac){
		var str ='<div class="control-group">';
		str +='<label class="control-label">Node MAC</label>';
		str +='<div class="controls">';
		str +='<input type="text" placeholder="Node MAC" class="m-wrap medium node-mac" value="'+nodeMac+'"/>';
		str +='</div>';
		str +='</div>';
		$('#portlet_tab3').append(str);
	}
	function loadManagers(managerId){
		var id = managerId ? managerId : '';
		if(id){
			console.log('Loadign an item');
			var parseManagers = function(data){
				console.log('manager data from server: ');
				console.log(data);
				var wizard = $('#edit-item');
				wizard.attr('data-id',managerId);
				var textInputs = wizard.find('input[type="text"]:not(.node-mac)');
				//var chbxInputs = man.find('input[type="checkbox"]');
				//var selectInputs = man.find('select');
				//var textAreas = man.find('textarea');
				//var chbxFilters = man.find('#campaign-filters input[type="checkbox"]');


				//Manager data:
				$.each(textInputs, function(index,i){
					i = $(i);
					var fieldName = i.attr('name');
					i.val(data[fieldName]);
				});
				//Nodes:
				$.each(data.nodes, function(i,n){
					addNewNode(n);
				});
				$('#managers-list').hide();
				$('#edit-item').show();
			
				/*$.each(chbxInputs, function(index,i){
					i = $(i);
					var fieldName = i.attr('name');
					i.prop('checked', data[fieldName] ? true : false);
				});
				$.each(selectInputs, function(index,i){
					i=$(i);
					var fieldName = i.attr('name');
					if(data[fieldName]){i.val(data[fieldName]);}
					console.log(fieldName +': '+data[fieldName]);
				});
				$.each(textAreas, function(index,i){
					i=$(i);
					var fieldName = i.attr('name');
					i.val(data[fieldName]);				
				});*/
				/*var sent = JSON.parse(data.sent);
				$('#sms-history .number').html(sent ? sent.sms : '0');
				$('#roost-history .number').html(sent ? sent.roost : '0');
				var filters = JSON.parse(data.filters);
				console.log(filters);
				console.log(chbxFilters.length);
				$.each(chbxFilters, function(index,i){
					i = $(i);
					var attr = i.attr('data-filter-attribute');
					var val = i.attr('data-filter-value');
					if(filters){
						if(filters[attr]){
							if(filters[attr].indexOf(val)>-1){
								i.prop('checked', true);		
							}
						}					
					}
				});*/
			}
		}else{
			console.log('Loading managers list:');
//			$('#tbl-managers > tbody').html('');
			var parseManagers =  function(data){
				console.log('managers data: ');
				console.log(data);
				var tbody = $('#tbl-managers > tbody');				
				var aaData = [];
				$.each(data,function(i,m){
					var editCell = '<button class="btn green mini edit" data-id="'+m.id+'">Edit</button>';
					var deleteCell = '<button class="btn red mini edit" data-id="'+m.id+'">Delete</button>';
					var manager = [m.name,m.vendorName,m.phoneNumber,m.email,editCell,deleteCell];
					
					aaData.push(manager);
				});
				if($('#tbl-managers').hasClass('initialized')){
					oTable.fnDestroy();
				}
				/*alert('initializing table');*/
				oTable = $('#tbl-managers').addClass('initialized').dataTable( {
    				"aaData":aaData,
    				"bFilter": true,
    				"bInfo": false,
    				"bPaginate": false,
		    		"oLanguage": {
		   				 "sSearch": "חיפוש: ",
		   				 "sZeroRecords": "לא נמצאו תוצאות"
		  			},
	 	 			"aoColumns": [
						{ "asSorting": [ "desc", "asc"] },
						{ "asSorting": [ "desc", "asc"] },
						{ "asSorting": [ "desc", "asc"] },
						{ "asSorting": [ "desc", "asc"] },
						null,
						null
					]
  				});
			}
		}
		
		$.ajax({
			type: "get",
			url: '/api/managers/'+id,
			success: parseManagers
		});
	}
	$(function(){
		App.init();
//	    TableManaged.init();
		
		$('#tbl-managers').on('click','a.delete-campaign',function(){
			$(this).parents('tr')[0].remove();
			updateManagers();
		});		

		/*===============ITEMS (Managers or Campaigns) ==========*/
		$('#btn-all-items').on('click',function(){ //TODO add dynamic managerId
			loadManagers();
			$('#edit-item').hide();
			$('#managers-list').show();
		}); 
		//Add new manager:
		$('#add-new-manager:not(.creating-manager)').on('click',function(){
			$(this).addClass('creating-manger');
			$.ajax({
					type: "post",
					url: '/api/managers',
					data: {},
					success: function(newId) {
						alert(newId);
						console.log(newId);
						loadManagers(newId);	//TODO this could be made with just one call...					
						$('#managers-list').hide();
						$('#edit-manger').show();

						//Adding row to the table:
						//oTable.fnAddData( [" "," "," "," ","<a>edit</a>","<a>delete</a>" ] );
					}
				});
		});
		//load single campagin
		loadManagers();
		//save campaign:
		$('#btn-save-item').on('click',function(){
			var data = {};
			var wizard = $($(this).parents('#edit-item')[0]);
			var id= wizard.attr('data-id');
			var textInputs = wizard.find('input[type="text"]:not(.node-mac)');
			var nodeMacs = wizard.find('input.node-mac[type="text"]');
			var chbxInputs = wizard.find('input[type="checkbox"]');

			var selectInputs = wizard.find('select');
			var textAreas = wizard.find('textarea');
			var chbxFilters = wizard.find('#campaign-filters input[type="checkbox"]');
			$.each(textInputs, function(index,i){
				i = $(i);
				if(!i.is(':disabled')){
					var fieldName = i.attr('name');
					data[fieldName]=i.val();
				}
			});
			//Nodes:
			var nodes=[];//TODO
			console.log(nodeMacs.length);
			$.each(nodeMacs, function(index,i){
				i = $(i);
				if(!i.is(':disabled')){
					var val = i.val();
//					var obj = {managerId:id,nodeMac:val};
					if( nodes.indexOf(val)<=-1 ){
						nodes.push(val);
					}
				}
			});
			/*$.each(chbxInputs, function(index,i){
				i = $(i);
				var fieldName = i.attr('name');
				data[fieldName]=i.is(':checked') ? 1 : 0;
			});
			$.each(selectInputs, function(index,i){
				i=$(i);
				var fieldName = i.attr('name');
				data[fieldName] = $(i.children('option:selected')[0]).attr('value');
				console.log('select found---'+fieldName);
			});
			$.each(textAreas, function(index,i){
				i=$(i);
				var fieldName = i.attr('name');
				data[fieldName] = i.val();				
			});*/
			
			//data.nodes=JSON.stringify(nodes);
			data.nodes=nodes;
			console.log('manager data from GUI: ');
			console.log(data);
			if(id>0){
				console.log('ajax');
				$.ajax({
					type: "post",
					url: '/api/managers/'+id,
					data: data,
					success: function(response) {
						console.log(response);
						//TODO add an "saved" notification
					}
				});
			}
		});
		$('#tbl-managers').on('click','.edit',function(){
			var managerId = $(this).attr('data-id');
			console.log(managerId);
			loadManagers(managerId);
			$('#managers-list').hide();
			$('#edit-item').show();
		});
		$('#tbl-managers').on('click','.delete',function(){
			var managerId = $($(this).closest('tr')[0]).attr('data-id');
			console.log('before delete -managerId: '+managerId);
			$.ajax({
				type: "delete",
				url: '/api/managers/'+managerId,
				success: function(deletedId){console.log('deleted! id: '+deletedId);}
			});
			$($(this).parents('tr')[0]).remove();
		});

		$('#btn-add-node').on('click',function(){
			addNewNode('');
		}); 
		//TRIGGERS SECTION:
	});
	</script>
</body>
<!-- END BODY -->
</html>
